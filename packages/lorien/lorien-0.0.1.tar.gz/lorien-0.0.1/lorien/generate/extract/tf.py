"""
The module of extracting workloads from TensorFlow models.
"""
import argparse
from typing import Any, Dict, List, Tuple

import yaml

from tvm import relay
from tvm.relay.frontend.tensorflow_parser import TFParser

from ...configs import create_config_parser, register_config_parser
from ...logger import get_logger
from ...workload import Workload
from ..generator import gen
from .extract import extract_from_model

log = get_logger('Extract-TF')


def extract_from_tf(configs: argparse.Namespace) -> List[Workload]:
    """Extract workloads from TensorFlow models.

    Parameters
    ----------
    configs: argparse.Namespace
        The system configure of generate.exctact.tf.
    Returns
    -------
    workloads: List[Workload]
        A list of collected workloads.
    """

    # Process models.
    mod_n_params: List[Tuple[relay.Module, Dict[str, Any]]] = []
    for model_desc in configs.model:
        model = yaml.load(model_desc, Loader=yaml.Loader)
        if isinstance(model, str):  # No shape specified. Use default
            model_path = model
            shape = {'Placeholder': (1, 224, 224, 3)}
        elif (isinstance(model, dict) and len(model) == 1
              and isinstance(list(model.values())[0], dict)):
            model_path = list(model.keys())[0]
            shape = model[model_path]
        else:
            raise RuntimeError('Unrecognized model description: %s' % model)

        try:
            # FIXME(comaniac): Trun off the warnings generated by Relay frontend.
            net = TFParser(model_path).parse()
            mod_n_params.append(relay.frontend.from_tensorflow(net, layout='NCHW', shape=shape))
        except Exception as err:  # pylint:disable=broad-except
            log.error('Failed to load and convert the TF model: %s', str(err))
            continue

    log.info('Collecting workloads from %d TensorFlow models', len(mod_n_params))
    return extract_from_model(configs, mod_n_params)


@register_config_parser('top.generate.extract.tf')
def define_config() -> argparse.ArgumentParser:
    """Define the command line interface for extracting TensorFlow models.

    Returns
    -------
    parser: argparse.ArgumentParser
        The defined argument parser.
    """
    parser = create_config_parser('Extract workloads from TensorFlow models')
    parser.add_argument('--model',
                        action='append',
                        default=[],
                        required=True,
                        help='A TF model file path with input name and shape in YAML format: '
                        '"<model-file-path>: {<input-name>: [<input-shape>]}". When ignored, '
                        'the default input {"Placeholder": (1, 224, 224, 3)} will be applied')
    parser.add_argument('--target',
                        action='append',
                        default=[],
                        required=True,
                        help='A TVM target (e.g., llvm, cuda, etc). '
                        'Note that the device tag (e.g., -model=v100) is not required.')
    parser.add_argument('-o', '--output', default='tf_workloads.yaml', help='The output file path')
    parser.set_defaults(entry=gen(extract_from_tf), validate_task=False)
    return parser
