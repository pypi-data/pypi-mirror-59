<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://hyperopt.github.io/hyperopt/scaleout/mongodb/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>MongoDB - Hyperopt Documentation</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/python.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">Hyperopt Documentation</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">Home</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting started <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../getting-started/overview/">Getting started with Hyperopt</a>
</li>
                                    
<li >
    <a href="../../getting-started/minimizing_functions/">Minimizing functions</a>
</li>
                                    
<li >
    <a href="../../getting-started/search_spaces/">Defining search spaces</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Installation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../setup/installation-notes/">Installation notes</a>
</li>
                                    
<li >
    <a href="../../setup/running-tests/">Running tests</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Scale out <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li class="active">
    <a href="./">MongoDB</a>
</li>
                                    
<li >
    <a href="../spark/">Spark</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Misc <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../interfacing-languages/">Interfacing with other languages</a>
</li>
                                    
<li >
    <a href="../../related-work/">Related work</a>
</li>
                                    
<li >
    <a href="../../scipy_submission/">SciPy 2013 submission</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../../setup/running-tests/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../spark/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li>
                                <a href="http://github.com/hyperopt/hyperopt/edit/master/docs/scaleout/mongodb.md"><i class="fa fa-github"></i> Edit on GitHub</a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#parallelizing-evaluations-during-search-via-mongodb">Parallelizing Evaluations During Search via MongoDB</a></li>
            <li><a href="#start-a-mongod-process">Start a mongod process</a></li>
            <li><a href="#use-mongotrials">Use MongoTrials</a></li>
            <li><a href="#run-hyperopt-mongo-worker">Run hyperopt-mongo-worker</a></li>
            <li><a href="#mongotrials-is-a-persistent-object">MongoTrials is a Persistent Object</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="parallelizing-evaluations-during-search-via-mongodb">Parallelizing Evaluations During Search via MongoDB</h1>
<p>Hyperopt is designed to support different kinds of trial databases.
The default trial database (<code>Trials</code>) is implemented with Python lists and dictionaries.
The default implementation is a reference implementation and it is easy to work with,
but it does not support the asynchronous updates required to evaluate trials in parallel.
For parallel search, hyperopt includes a <code>MongoTrials</code> implementation that supports asynchronous updates.</p>
<p>To run a parallelized search, you will need to do the following (after <a href="Installation-Notes">installing mongodb</a>):</p>
<ol>
<li>
<p>Start a mongod process somewhere network-visible.</p>
</li>
<li>
<p>Modify your call to <code>hyperopt.fmin</code> to use a MongoTrials backend connected to that mongod process.</p>
</li>
<li>
<p>Start one or more <code>hyperopt-mongo-worker</code> processes that will also connect to the mongod process,
    and carry out the search while <code>fmin</code> blocks.</p>
</li>
</ol>
<h2 id="start-a-mongod-process">Start a mongod process</h2>
<p>Once mongodb is installed, starting a database process (mongod) is as easy as typing e.g.</p>
<pre><code class="bash">mongod --dbpath . --port 1234
# or storing each db its own directory is nice:
mongod --dbpath . --port 1234 --directoryperdb --journal --nohttpinterface
# or consider starting mongod as a daemon:
mongod --dbpath . --port 1234 --directoryperdb --fork --journal --logpath log.log --nohttpinterface
</code></pre>

<p>Mongo has a habit of pre-allocating a few GB of space (you can disable this with --noprealloc) for better performance, so think a little about where you want to create this database.
Creating a database on a networked filesystem may give terrible performance not only to your database but also to everyone else on your network, be careful about it.</p>
<p>Also, if your machine is visible to the internet, then either bind to the loopback interface and connect via ssh or read mongodb's documentation on password protection.</p>
<p>The rest of the tutorial is based on mongo running on <strong>port 1234</strong> of the <strong>localhost</strong>.</p>
<h2 id="use-mongotrials">Use MongoTrials</h2>
<p>Suppose, to keep things really simple, that you wanted to minimize the <code>math.sin</code> function with hyperopt.
To run things in-process (serially) you could type things out like this:</p>
<pre><code class="python">import math
from hyperopt import fmin, tpe, hp, Trials

trials = Trials()
best = fmin(math.sin, hp.uniform('x', -2, 2), trials=trials, algo=tpe.suggest, max_evals=10)
</code></pre>

<p>To use the mongo database for persistent storage of the experiment, use a <code>MongoTrials</code> object instead of <code>Trials</code> like this:</p>
<pre><code class="python">import math
from hyperopt import fmin, tpe, hp
from hyperopt.mongoexp import MongoTrials

trials = MongoTrials('mongo://localhost:1234/foo_db/jobs', exp_key='exp1')
best = fmin(math.sin, hp.uniform('x', -2, 2), trials=trials, algo=tpe.suggest, max_evals=10)
</code></pre>

<p>The first argument to MongoTrials tells it what mongod process to use, and which <em>database</em> (here 'foo_db') within that process to use.
The second argument (<code>exp_key='exp_1'</code>) is useful for tagging a particular set of trials <em>within</em> a database.
The exp_key argument is technically optional.</p>
<p><strong>N.B.</strong> There is currently an implementation requirement that the database name be followed by '/jobs'.</p>
<p>Whether you always put your trials in separate databases or whether you use the exp_key mechanism to distinguish them is up to you.
In favour of databases: they can be manipulated from the shell (they appear as distinct files) and they ensure greater independence/isolation of experiments.
In favour of exp_key: hyperopt-mongo-worker processes (see below) poll at the database level so they can simultaneously support multiple experiments that are using the same database.</p>
<h2 id="run-hyperopt-mongo-worker">Run <code>hyperopt-mongo-worker</code></h2>
<p>If you run the code fragment above, you will see that it blocks (hangs) at the call fmin.
MongoTrials describes itself internally to fmin as an <em>asynchronous</em> trials object, so fmin
does not actually evaluate the objective function when a new search point has been suggested.
Instead, it just sits there, patiently waiting for another process to do that work and update the mongodb with the results.
The <code>hyperopt-mongo-worker</code> script included in the <code>bin</code> directory of hyperopt was written for this purpose.
It should have been installed on your <code>$PATH</code> when you installed hyperopt.</p>
<p>While the <code>fmin</code> call in the script above is blocked, open a new shell and type</p>
<pre><code class="bash">hyperopt-mongo-worker --mongo=localhost:1234/foo_db --poll-interval=0.1
</code></pre>

<p>It will dequeue a work item from the mongodb, evaluate the <code>math.sin</code> function, store the results back to the database.
After the <code>fmin</code> function has tried enough points it will return and the script above will terminate.
The <code>hyperopt-mongo-worker</code> script will then sit around for a few minutes waiting for more work to appear, and then terminate too.</p>
<p>We set the poll interval explicitly in this case because the default timings are set up for jobs (search point evaluations) that take at least a minute or two to complete.</p>
<h2 id="mongotrials-is-a-persistent-object">MongoTrials is a Persistent Object</h2>
<p>If you run the example above a second time,</p>
<pre><code class="python">best = fmin(math.sin, hp.uniform('x', -2, 2), trials=trials, algo=tpe.suggest, max_evals=10)
</code></pre>

<p>you will see that it returns right away and nothing happens.
That's because the database you are connected to already has enough trials in it; you already computed them when you ran the first experiment.
If you want to do another search, you can change the database name or the <code>exp_key</code>.
If you want to extend the search, then you can call fmin with a higher number for <code>max_evals</code>.
Alternatively, you can launch other processes that create the MongoTrials specifically to analyze the results that are already in the database. Those other processes do not need to call fmin at all.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"search": 83, "next": 78, "help": 191, "previous": 80};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
