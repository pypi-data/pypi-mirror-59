{% extends "bee_django_crm/base.html" %}
{% load bee_django_crm_filter %}
{% load static %}
{% block content %}
    {% include 'bee_django_crm/logo.html' %}
    {% include 'bee_django_crm/nav.html' %}
    {% include 'bee_django_crm/messages.html' %}
    <h4>合同详情</h4>
    {% if not preuser_contract.is_user_agree %}
        <a href="{% url 'bee_django_crm:preuser_contract_update' preuser_contract.id %}">修改合同</a>
    {% endif %}
    <table class="table">
        <tr>
            <td>学生</td>
            <td>{{ preuser_contract.preuser.name }}</td>
        </tr>
        <tr>
            <td>合同</td>
            <td>{{ preuser_contract.contract.name }}</td>
        </tr>
        <tr>
            <td>合同时长</td>
            <td>{{ preuser_contract.contract.get_contract_days }}</td>
        </tr>
        <tr>
            <td>合同金额</td>
            <td>
                {{ preuser_contract.contract.price }}
            </td>
        </tr>
        <tr>
            <td>应交金额</td>
            <td>
                {{ preuser_contract.price }}
            </td>
        </tr>
        <tr>
            <td>开课日期</td>
            <td>
                {{ preuser_contract.study_at|default:"" }}
            </td>
        </tr>
        <tr>
            <td>结课日期</td>
            <td>
                {{ preuser_contract.finish_at|default:"" }}
            </td>
        </tr>
        <tr>
            <td>备注</td>
            <td>
                {{ preuser_contract.info }}
            </td>
        </tr>
        <tr>
            <td>协议</td>
            <td>
                {% if preuser_contract.is_user_agree %}
                    已签协议
                {% else %}
                    <a href="{% url 'bee_django_crm:preuser_contract_agreement' preuser_contract.id %}">协议链接</a>
                {% endif %}
            </td>

        </tr>


    </table>

    <hr>
    <h4>缴费记录</h4>
    {% if preuser_contract.is_user_agree %}
        {% if perms.bee_django_crm.add_preuserfee %}
            <a href="{% url 'bee_django_crm:preuser_fee_add' preuser_contract.id %}">添加缴费</a>
        {% endif %}
    {% endif %}
    <table class="table">
        <thead>
        <tr>
            <th></th>
            <th>缴费类型</th>
            <th>实际缴费金额</th>
            <th>缴费时间</th>
            <th></th>
        </tr>
        </thead>
        {% for fee in preuser_contract.preuserfee_set.all %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ fee.get_pay_status }}</td>
                <td>{{ fee.price }}</td>
                <td>{{ fee.paid_at|local_datetime|date:"Y-m-d" }}</td>

                <td><a href="{% url 'bee_django_crm:preuser_fee_detail' fee.id %}">详情</a></td>
                <td>
                    {% if not fee.is_checked %}
                        {#                        <a href="{% url 'bee_django_crm:preuser_contract_update' user_contract.id %}">修改</a>#}
                        <a href="#"
                           data-confirm="{% url "bee_django_crm:preuser_fee_delete" fee.id %}"
                           onclick="click_del(this)">删除</a>
                        {% if perms.bee_django_crm.can_check_crm_preuser_fee %}
                            <a href="#" id="check_{{ fee.id }}"
                               data-confirm="{% url "bee_django_crm:preuser_fee_update_check" fee.id %}"
                               onclick="click_check(this)">审核</a>
                        {% endif %}
                    {% else %}
                        已审核
                        {% if fee.after_checked_at %}
                            已完成后续操作
                        {% else %}
                            {{ fee|get_after_check_url:request.user|safe }}
                        {% endif %}

                    {% endif %}

                </td>
            </tr>

        {% endfor %}
    </table>
{% endblock %}


{% block scripts %}
    <script>
        $(document).ready(function () {

        });
        function click_del(_this) {
            if (!confirm('确认要执行这个操作？')) {
                return false;
            }
            var url = $(_this).attr('data-confirm');
            $.post(url).done(function (data) {
                alert('删除成功!');
                location.reload();
            });
        }

        function click_check(_this) {
            if (!confirm('确认要执行这个操作？')) {
                return false;
            }
            var url = $(_this).attr('data-confirm');
            $.post(url).done(function (data) {
                alert('审核成功!');

                location.href = data.url;
            });
        }
    </script>
{% endblock %}