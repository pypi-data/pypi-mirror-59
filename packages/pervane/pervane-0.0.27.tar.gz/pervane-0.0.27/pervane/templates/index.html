<html>
 <head>
    <title>Pervane - Plain text based note taking app</title>

    <link rel="apple-touch-icon" sizes="180x180" href="static/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="static/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="static/img/favicon/favicon-16x16.png">

    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/styles/default.min.css">
    <!-- <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" > -->
    <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.4.1/darkly/bootstrap.min.css" rel="stylesheet" >
    <link href="https://fonts.googleapis.com/css?family=PT+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/editormd.min.css" />
    <link rel="stylesheet" href="/static/css/styles.css" />
    <style>
    </style>
 </head>
 <body>

<header>
  <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <a class="navbar-brand" href="#">Pervane</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item active">
          <a class="nav-link" href="/">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-toggle="modal" data-target="#settings-modal">Settings</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/hakanu/pervane">Contribute</a>
        </li>
      </ul>
      <form class="form-inline mt-2 mt-md-0" action="/search" method="GET">
        <input class="form-control mr-sm-2" type="text" name="query" placeholder="Search files with ag" aria-label="Search">
      </form>
    </div>
  </nav>
</header>

<div class="">
  <div class="row">
    <div class="col-md-2 sidebar">
      <p>
        <a href="/">
          <i class="fa fa-folder" aria-hidden="true"></i>
          {{ tree.path}}
        </a>

        <span>
          <a href="#" onclick="addNode('{{ tree.path }}')">
            <i class="fa fa-plus-square" aria-hidden="true"></i>
          </a>
        </span>
      </p>

      <ul>
      {%- for item in tree.children recursive %}
          <li>
        {% if '.' in item.name and not item.name.startswith('.')  %}
          <a href="/file?f={{ item.path }}">
            {% if item.path.endswith('.md') %}
              <i class="fa fa-file-text" aria-hidden="true"></i>
            {% else %}
              <i class="fa fa-file-code-o" aria-hidden="true"></i>
            {% endif %}
            {{ item.name }}
          </a>
        {% else %}
          <a href="#" data-href="/dir?d={{ item.path }}" class="expand">
            <i class="fa fa-folder" aria-hidden="true"></i>
            {{ item.name }}/
          </a>

          &nbsp;&nbsp;
          <span>
            <a href="#" onclick="addNode('{{ item.path }}')">
              <i class="fa fa-plus-square" aria-hidden="true"></i>
            </a>
          </span>
        {% endif %}

        {%- if item.children -%}
            <ul id="{{item.path|replace(' ', '_')|replace('/', '-'|replace('\\', '-'))}}">{{ loop(item.children) }}</ul>
        {%- endif %}
          </li>
      {%- endfor %}
      </ul>
    </div>

    <div class="col-md-10">
      {% if not search_results %}
        <h6>
          <a id="a-path" href="file://{{path}}" target="_blank">{{ path }}</a>&nbsp;&nbsp;
          <span><a href="#" onclick="update()">ðŸ’¾</a></span>
          <sub id="status"></sub>
        </h6>
        {% if ext == '.md' %}
          {% if not md_content and html_content %}
            <div>{{ html_content|safe }}</div>
          {% else %}
            <!-- <div id="editorSection"></div> -->
            <div id="editor">
              <!-- Tips: Editor.md can auto append a `<textarea>` tag -->
              <textarea style="display:none;">### Hello Editor.md !</textarea>
            </div>
          {% endif %}
        {% else %}
          <pre><code class="{{ext|replace('.', '')}}">{{ html_content|e }}</code></pre>
        {% endif %}
      {% else %}
        <h6>Results for <b>{{ query|e }}</b></h6>
        <p><sub>{{ stats }}</sub></p>
        {% for result in search_results %}
          <a href="/file?f={{ result.file}}" target="_blank">{{ result.file }}</a>
          <ul>
            {% for match in result.matches %}
              <li><pre>{{match.snippet}}</pre></li>
            {% endfor %}
          </ul>
        {% endfor %}
      {% endif %}

      
    </div>
  </div>
</div>

<br>
<br>


<!-- New folder/file Modal -->
<div class="modal fade" id="nodeModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLongTitle">Create new node</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <form action="/api/add_node" method="POST">
        <div class="modal-body">
          <p>Put / at the end if you want to create a directory. Otherwise we append a .md suffix for you.</p>
          <div class="input-group mb-3">
              <input id="modal-input-parent-path" type="hidden" name="parent_path" class="form-control"> 
              <div class="input-group-prepend">
                  <span id="modal-input-prefix" class="input-group-text"></span>
              </div>
              <input type="text" name="new_node_name" class="form-control" placeholder="Type new node's name">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary">Add node</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settings-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Settings</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <header>
          <h6>Themes</h6>
          <div class="form-group">
            <select class="form-control" id="editormd-theme-select">
              <option selected="selected" value="">select Editor.md themes</option>
            </select><br>
            <select class="form-control" id="editor-area-theme-select">
              <option selected="selected" value="">select editor area themes</option>
            </select><br>
            <select class="form-control" id="preview-area-theme-select">
              <option selected="selected" value="">select preview area themes</option>
            </select><br>
          </div>
        </header>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.17.1/build/highlight.min.js"></script>
<script src="/static/js/editormd.min.js"></script>
<script src="/static/js/en.js"></script>
<script>
// Get expand/collapse memory from localstorage.
for (var i = 0; i < localStorage.length; i++) {
  var key = localStorage.key(i);
  var value = localStorage.getItem(key);
  // Hacky but useful way to generate ids from folder paths.
  // needed to use false as a str because is(visible) is serialized :/
  if (value != 'false') {
    $('#' + key).eq(0).css("display", "block");
  }
}

document.addEventListener('DOMContentLoaded', (event) => {
  document.querySelectorAll('pre code').forEach((block) => {
    hljs.highlightBlock(block);
  });
}); 

// Consider enabling dark mode. Need more work though.
// TUI Editor doesn't have dark mode.
//new Darkmode().showWidget();

$('.expand').click(function() {
  var nearest_ul = $('ul', $(this).parent()).eq(0);
  nearest_ul.toggle();
  window.localStorage.setItem(nearest_ul.attr('id'),
                              nearest_ul.is(':visible'));
});

{% if (md_content or md != '') and path %}
    initEditor('{{path}}');      
{% endif %}

var editor = null;

function initEditor(path) {
  if (path) {
    $.get( 
      "/api/get_content", { 
        f: path 
      }, 
      function(data) { 
        if (data.result == 'success') {
          // TODO(hakanu): No idea why this is not working.
          // editor.setValue(data.content);
          // editor.setMarkdown(data.content);
          editor = editormd("editor", {
              width: "100%",
              // height: "300%",
              taskList: true,
              autoHeight: true,
              codeFold: true,
              searchReplace: true,
              flowChart : true,
              sequenceDiagram : true,
              theme: (localStorage.theme) ? localStorage.theme : "dark",
              previewTheme: (localStorage.previewTheme) ? localStorage.previewTheme : "dark", 
              editorTheme: (localStorage.editorTheme) ? localStorage.editorTheme : "pastel-on-dark", 
              // TODO(hakanu): Needed to load like this. Otherwise editor
              // puts its own placeholder to the textarea instead of empty.
              markdown: data.content + '\n',  
              path : "/static/js/lib/"  // Autoload modules mode.
          });
        } else {
          console.log('something went wrong while fetching the file content', data.result);
          $('#status').text('something went wrong while fetching the file content', data.result);
        }
      }); 
  }
}

function update() {
  var text = editor.getMarkdown();
  var file_path = $('#a-path').text();
  $.post('/api/update', {updated_content: text, file_path: file_path}, function(result){
    if (result.result == 'success') {
      $('#status').text('Updated @ ' + (new Date()));
    } else {
      $('#status').text('Failed to update @ ' + (new Date()));
    }
  });
}

function addNode(parent) {
  $('#modal-input-parent-path').attr('value', parent);
  $('#modal-input-prefix').text(parent + '/');
  $('#nodeModal').modal();
}

function themeSelect(id, themes, lsKey, callback) {
  var select = $("#" + id);
  for (var i = 0, len = themes.length; i < len; i ++) {                    
      var theme    = themes[i];
      var selected = (localStorage[lsKey] == theme) ? " selected=\"selected\"" : "";
      select.append("<option value=\"" + theme + "\"" + selected + ">" + theme + "</option>");
  }
  
  select.bind("change", function(){
      var theme = $(this).val();
      if (theme === "") {
          alert("theme == \"\"");
          return false;
      }
      console.log("lsKey =>", lsKey, theme);
      localStorage[lsKey] = theme;
      callback(select, theme);
  }); 
  return select;
}

themeSelect("editormd-theme-select", editormd.themes, "theme", function($this, theme) {
    editor.setTheme(theme);
});

themeSelect("editor-area-theme-select", editormd.editorThemes, "editorTheme", function($this, theme) {
    editor.setCodeMirrorTheme(theme); 
});

themeSelect("preview-area-theme-select", editormd.previewThemes, "previewTheme", function($this, theme) {
    editor.setPreviewTheme(theme);
}); 
</script>
</body>
</html>
