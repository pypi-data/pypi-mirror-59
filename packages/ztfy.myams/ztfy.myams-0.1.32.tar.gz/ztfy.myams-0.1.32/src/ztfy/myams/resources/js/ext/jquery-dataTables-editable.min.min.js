!function(e){e.fn.makeEditable=function(t){function n(t){return y.fnGetRowID(e(t.parentNode))}function o(t){if(!y.bDisableEditing){var o={event:"dblclick",onsubmit:function(t,o){if(T=o.revert,k=null,sNewCellDisplayValue=null,B=w(),"text"==t.type||"select"==t.type||"textarea"==t.type){var a=e("input,select,textarea",this);if(k=e("input,select,textarea",e(this)).val(),1==a.length){var s=a[0];"select"==s.nodeName.toLowerCase()||"select"==s.tagName.toLowerCase()?sNewCellDisplayValue=e("option:selected",s).text():sNewCellDisplayValue=k}if(!y.fnOnEditing(a,t,o.revert,n(o)))return!1;return null!=t.oValidationOptions&&a.parents("form").validate(t.oValidationOptions),null!=t.cssclass&&a.addClass(t.cssclass),null==t.cssclass&&null==t.oValidationOptions||!(!a.valid()||0==a.valid())}y.fnStartProcessingMode()},submitdata:function(t,o){var a=n(this),s=g.fnGetPosition(this)[0],l=g.fnGetPosition(this)[1],i=g.fnGetPosition(this)[2],d=g.fnSettings().aoColumns[i].sName;null!=d&&""!=d||(d=g.fnSettings().aoColumns[i].sTitle);return null==y.aoColumns||null==y.aoColumns[i]?e.extend({},y.oUpdateParameters,{id:a,rowId:s,columnPosition:l,columnId:i,columnName:d}):e.extend({},y.oUpdateParameters,y.aoColumns[i].oUpdateParameters,{id:a,rowId:s,columnPosition:l,columnId:i,columnName:d})},callback:function(t,n){y.fnEndProcessingMode();var o="",a=g.fnGetPosition(this),s=!E.oFeatures.bServerSide;if(e("td.last-updated-cell",g.fnGetNodes()).removeClass("last-updated-cell"),t.indexOf(y.sFailureResponsePrefix)>-1?(g.fnUpdate(T,a[0],a[2],s),e("td.last-updated-cell",g).removeClass("last-updated-cell"),e(this).addClass("last-updated-cell"),y.fnShowError(t.replace(y.sFailureResponsePrefix,"").trim(),"update"),o="failure"):"IGNORE"==y.sSuccessResponse||null!=y.aoColumns&&null!=y.aoColumns[a[2]]&&"IGNORE"==y.aoColumns[a[2]].sSuccessResponse||null==k||k==t||y.sSuccessResponse==t?(null==sNewCellDisplayValue?g.fnUpdate(t,a[0],a[2],s):g.fnUpdate(sNewCellDisplayValue,a[0],a[2],s),e("td.last-updated-cell",g).removeClass("last-updated-cell"),e(this).addClass("last-updated-cell"),o="success"):(g.fnUpdate(T,a[0],a[2],s),y.fnShowError(t,"update"),o="failure"),y.fnOnEdited(o,T,sNewCellDisplayValue,a[0],a[1],a[2]),null!=n.fnOnCellUpdated&&n.fnOnCellUpdated(o,t,a[0],a[2],n),h(),y.bUseKeyTable){var l=g.keys;setTimeout(function(){l.block=!1},0)}},onerror:function(){y.fnEndProcessingMode(),y.fnShowError("Cell cannot be updated","update"),y.fnOnEdited("failure")},onreset:function(){if(y.bUseKeyTable){var e=g.keys;setTimeout(function(){e.block=!1},0)}},height:y.sEditorHeight,width:y.sEditorWidth},a=null;if(null!=y.aoColumns){for(var s=0,l=0;s<E.aoColumns.length;s++)if(E.aoColumns[s].bVisible){if(null==y.aoColumns[l]){l++;continue}a=e("td:nth-child("+(l+1)+")",t);var i=o;i=e.extend({},o,y.oEditableSettings,y.aoColumns[l]),l++;var d=y.sUpdateURL;try{null!=i.sUpdateURL&&(d=i.sUpdateURL)}catch(e){}a.each(function(){e(this).hasClass(y.sReadOnlyCellClass)||e(this).editable(d,i)})}}else(a=e("td:not(."+y.sReadOnlyCellClass+")",t)).editable(y.sUpdateURL,e.extend({},o,y.oEditableSettings))}}function a(t){if(y.fnOnAdding()&&S.valid())if(B=w(),y.fnStartProcessingMode(),y.bUseFormsPlugin)e(S).ajaxSubmit({dataType:"xml",success:function(e,t,n){-1!=n.responseText.toLowerCase().indexOf("error")?(y.fnEndProcessingMode(),y.fnShowError(n.responseText.replace("Error",""),"add"),y.fnOnAdded("failure")):s(n.responseText)},error:function(e){y.fnEndProcessingMode(),y.fnShowError(e.responseText,"add"),y.fnOnAdded("failure")}});else{var n=S.serialize();e.ajax({url:y.sAddURL,data:n,type:y.sAddHttpMethod,dataType:y.sAddDataType,success:s,error:function(e){y.fnEndProcessingMode(),y.fnShowError(e.responseText,"add"),y.fnOnAdded("failure")}})}t.stopPropagation(),t.preventDefault()}function s(t){if(y.fnEndProcessingMode(),y.fnOnNewRowPosted(t)){var n=g.fnSettings();if(!n.oFeatures.bServerSide){jQuery.data(S,"DT_RowId",t);var a,s=C(S);a=null!=n.aoColumns&&isNaN(parseInt(n.aoColumns[0].mDataProp))?g.fnAddData(rowData):g.fnAddData(s);var l=g.fnGetNodes(a);y.fnSetRowID(e(l),t,!0),o(l),e("tr.last-added-row",g).removeClass("last-added-row"),e(l).addClass("last-added-row")}if(S.dialog("close"),e(S)[0].reset(),e(".error",e(S)).html(""),h(),y.fnOnAdded("success"),y.bUseKeyTable){var i=g.keys;setTimeout(function(){i.block=!1},0)}}}function l(t){e(S).validate().resetForm(),e(S)[0].reset(),e(".error",e(S)).html(""),e(".error",e(S)).hide(),S.dialog("close"),t.stopPropagation(),t.preventDefault()}function d(){y.bUseKeyTable||(null!=y.oDeleteRowButtonOptions?v.button("option","disabled",!0):v.attr("disabled","true"))}function r(){null!=y.oDeleteRowButtonOptions?v.button("option","disabled",!1):v.removeAttr("disabled")}function u(t){var o=e(this).attr("href");null!=o&&""!=o||(o=y.sDeleteURL),t.preventDefault(),t.stopPropagation(),B=w(),P=e(this).parents("td")[0],jSelectedRow=e(this).parents("tr"),x=jSelectedRow[0],jSelectedRow.addClass(y.sSelectedRowClass);var a=n(P);y.fnOnDeleting(jSelectedRow,a,f)&&f(a,o)}function c(t){if(t.preventDefault(),t.stopPropagation(),B=w(),x=null,P=null,y.bUseKeyTable)P=e("td.focus",g)[0];else{if(0==e("tr."+y.sSelectedRowClass+" td",g).length)return void _fnDisableDeleteButton();P=e("tr."+y.sSelectedRowClass+" td",g)[0]}if(null!=P){y.bUseKeyTable&&(I=g.keys.fnGetCurrentPosition());var o=n(P),a=e(P).parent("tr");x=a[0],y.fnOnDeleting(a,o,f)&&f(o)}else d()}function f(t,n){var o=n;null==n&&(o=y.sDeleteURL),y.fnStartProcessingMode();var a=e.extend(y.oDeleteParameters,{id:t});e.ajax({url:o,type:y.sDeleteHttpMethod,data:a,success:p,dataType:y.sDeleteDataType,error:function(e){y.fnEndProcessingMode(),y.fnShowError(e.responseText,"delete"),y.fnOnDeleted("failure")}})}function p(e){y.fnEndProcessingMode();var t=x;e==y.sSuccessResponse||""==e?(g.fnDeleteRow(t),d(),h(),y.bUseKeyTable&&g.keys.fnSetPosition(I[0],I[1]),y.fnOnDeleted("success")):(y.fnShowError(e,"delete"),y.fnOnDeleted("failure"))}function w(){return E._iDisplayStart}function h(){E._iDisplayStart=B,E.oApi._fnCalculateEnd(E),E.oApi._fnDraw(E)}function m(e){y.aoTableAction&&y.fnShowError("Configuration error - aoTableAction setting are not set",e);var t=0;for(t=0;t<y.aoTableActions.length;t++)if(y.aoTableActions[t].sAction==e)return y.aoTableActions[t];y.fnShowError("Cannot find action configuration settings",e)}function b(t,n){var o=g.fnGetPosition(n),a=y.fnGetRowID(e(n));e(t).validate().resetForm(),jQuery.data(e(t)[0],"DT_RowId",a),e("input.DT_RowId",e(t)).val(a),jQuery.data(e(t)[0],"ROWID",o),e("input.ROWID",e(t)).val(o);var s=g.fnSettings().aoColumns.length;e("input:text[rel],input:radio[rel][checked],input:hidden[rel],select[rel],textarea[rel],input:checkbox[rel]",e(t)).each(function(){var t=e(this).attr("rel");if(t>=s)y.fnShowError("In the form is placed input element with the name '"+e(this).attr("name")+"' with the 'rel' attribute that must be less than a column count - "+s,"action");else{var o=g.fnGetData(n)[t];if("select"==this.nodeName.toLowerCase()||"select"==this.tagName.toLowerCase())if(1==this.multiple){var a=new Array;for(aoCellValues=o.split(","),i=0;i<=this.options.length-1;i++)-1!=jQuery.inArray(this.options[i].text.toLowerCase().trim(),aoCellValues)&&a.push(this.options[i].value);e(this).val(a)}else for(i=0;i<=this.options.length-1;i++)this.options[i].text.toLowerCase()==o.toLowerCase()&&e(this).val(this.options[i].value);else"span"==this.nodeName.toLowerCase()||"span"==this.tagName.toLowerCase()?e(this).html(o):"checkbox"==this.type?"true"==o&&e(this).attr("checked",!0):"radio"==this.type?this.value==o&&(this.checked=!0):this.value=o}})}function C(t){var n=jQuery.data(t,"DT_RowId"),o=E.aoColumns.length,a=new Array,s=new Object;return e("input:text[rel],input:radio[rel][checked],input:hidden[rel],select[rel],textarea[rel],span.datafield[rel],input:checkbox[rel]",t).each(function(){var t=e(this).attr("rel"),l="";t>=o?y.fnShowError("In the add form is placed input element with the name '"+e(this).attr("name")+"' with the 'rel' attribute that must be less than a column count - "+o,"add"):(l=(l=(l="select"==this.nodeName.toLowerCase()||"select"==this.tagName.toLowerCase()?e.map(e.makeArray(e("option:selected",this)),function(t,n){return e(t).text()}).join(","):"span"==this.nodeName.toLowerCase()||"span"==this.tagName.toLowerCase()?e(this).html():"checkbox"==this.type?this.checked?"on"!=this.value?this.value:"true":"on"!=this.value?"":"false":this.value).replace("DATAROWID",n)).replace(y.sIDToken,n),null!=E.aoColumns&&null!=E.aoColumns[t]&&isNaN(parseInt(E.aoColumns[0].mDataProp))?s[E.aoColumns[t].mDataProp]=l:a[t]=l)}),null!=E.aoColumns&&isNaN(parseInt(E.aoColumns[0].mDataProp))?s:a}function R(t){var n=e(t),o=n.attr("id");o=o.replace("form","");var a=n.attr("action");if(y.fnOnBeforeAction(o)&&n.valid())if(B=w(),y.fnStartProcessingMode(),y.bUseFormsPlugin){var s={success:function(e,n,a){y.fnEndProcessingMode(),-1!=e.toLowerCase().indexOf("error")||"success"!=n?(y.fnShowError(e,o),y.fnOnActionCompleted("failure")):(A(t),y.fnOnActionCompleted("success"))},error:function(e){y.fnEndProcessingMode(),y.fnShowError(e.responseText,o),y.fnOnActionCompleted("failure")}};m(o);s=e.extend({},y.oAjaxSubmitOptions,s),e(oActionForm).ajaxSubmit(s)}else{var l=n.serialize();e.ajax({url:a,data:l,type:y.sAddHttpMethod,dataType:y.sAddDataType,success:function(e){y.fnEndProcessingMode(),A(t),y.fnOnActionCompleted("success")},error:function(e){y.fnEndProcessingMode(),y.fnShowError(e.responseText,o),y.fnOnActionCompleted("failure")}})}}function A(t){for(var n=C(t),o=jQuery.data(t,"ROWID"),a=g.fnSettings(),s=a.aoColumns.length,l=0;l<s;l++)null!=a.aoColumns&&null!=a.aoColumns[l]&&isNaN(parseInt(a.aoColumns[0].mDataProp))?sCellValue=rowData[a.aoColumns[l].mDataProp]:sCellValue=n[l],void 0!=sCellValue&&g.fnUpdate(sCellValue,o,l);h(),e(t).dialog("close")}var g,O,v,D,N,S,y,T,k,x,P,I,E,B=0;g=this;var U={sUpdateURL:"UpdateData",sAddURL:"AddData",sDeleteURL:"DeleteData",sAddNewRowFormId:"formAddNewRow",oAddNewRowFormOptions:{autoOpen:!1,modal:!0},sAddNewRowButtonId:"btnAddNewRow",oAddNewRowButtonOptions:null,sAddNewRowOkButtonId:"btnAddNewRowOk",sAddNewRowCancelButtonId:"btnAddNewRowCancel",oAddNewRowOkButtonOptions:{label:"Ok"},oAddNewRowCancelButtonOptions:{label:"Cancel"},sDeleteRowButtonId:"btnDeleteRow",oDeleteRowButtonOptions:null,sSelectedRowClass:"row_selected",sReadOnlyCellClass:"read_only",sAddDeleteToolbarSelector:".add_delete_toolbar",fnShowError:function(e,t){alert(e)},fnStartProcessingMode:function(){g.fnSettings().oFeatures.bProcessing&&e(".dataTables_processing").css("visibility","visible")},fnEndProcessingMode:function(){g.fnSettings().oFeatures.bProcessing&&e(".dataTables_processing").css("visibility","hidden")},aoColumns:null,fnOnDeleting:function(e,t,n){return confirm("Are you sure that you want to delete this record?")},fnOnDeleted:function(e){},fnOnAdding:function(){return!0},fnOnNewRowPosted:function(e){return!0},fnOnAdded:function(e){},fnOnEditing:function(e){return!0},fnOnEdited:function(e,t,n,o,a,s){},sAddHttpMethod:"POST",sAddDataType:"text",sDeleteHttpMethod:"POST",sDeleteDataType:"text",fnGetRowID:function(e){return e.attr("id")},fnSetRowID:function(e,t,n){n?e.attr("id",t):null!=e.attr("id")&&""!=e.attr("id")||e.attr("id",t)},sEditorHeight:"100%",sEditorWidth:"100%",bDisableEditing:!1,oEditableSettings:null,oDeleteParameters:{},oUpdateParameters:{},sIDToken:"DT_RowId",aoTableActions:null,fnOnBeforeAction:function(e){return!0},bUseFormsPlugin:!1,fnOnActionCompleted:function(e){},sSuccessResponse:"ok",sFailureResponsePrefix:"ERROR",oKeyTable:null};return y=e.extend(U,t),E=g.fnSettings(),y.bUseKeyTable=null!=y.oKeyTable,this.each(function(){var t=g.dataTableSettings[0].sTableId;if(y.bUseKeyTable){var n=new KeyTable({table:document.getElementById(t),datatable:g});g.keys=n,n.event.action(null,null,function(t){e(t).hasClass(y.sReadOnlyCellClass)||(n.block=!0,setTimeout(function(){e(t).dblclick()},0))})}if(null!=g.fnSettings().sAjaxSource?g.fnSettings().aoDrawCallback.push({fn:function(){o(g.fnGetNodes()),e(g.fnGetNodes()).each(function(){var t=g.fnGetPosition(this),n=g.fnGetData(t)[0];y.fnSetRowID(e(this),n)})},sName:"fnApplyEditable"}):o(g.fnGetNodes()),0!=(S=e("#"+y.sAddNewRowFormId)).length){var s=g.fnSettings().aoColumns.length;for(f=0;f<s;f++)0==e("[rel="+f+"]",S).length&&y.fnShowError("In the form that is used for adding new records cannot be found an input element with rel="+f+" that will be bound to the value in the column "+f+". See http://code.google.com/p/jquery-datatables-editable/wiki/AddingNewRecords#Add_new_record_form for more details","init");if(null!=y.oAddNewRowFormOptions?y.oAddNewRowFormOptions.autoOpen=!1:y.oAddNewRowFormOptions={autoOpen:!1},S.dialog(y.oAddNewRowFormOptions),0!=(O=e("#"+y.sAddNewRowButtonId)).length)"true"!=O.data("add-event-attached")&&(O.click(function(){S.dialog("open")}),O.data("add-event-attached","true"));else{if(0==e(y.sAddDeleteToolbarSelector).length)throw"Cannot find a button with an id '"+y.sAddNewRowButtonId+"', or placeholder with an id '"+y.sAddDeleteToolbarSelector+"' that should be used for adding new row although form for adding new record is specified";O=null}"form"==S[0].nodeName.toLowerCase()?(S.unbind("submit"),S.submit(function(e){return a(e),!1})):(e("form",S[0]).unbind("submit"),e("form",S[0]).submit(function(e){return a(e),!1}));var i=[];0==(D=e("#"+y.sAddNewRowOkButtonId,S)).length?(null!=y.oAddNewRowOkButtonOptions.text&&""!=y.oAddNewRowOkButtonOptions.text||(y.oAddNewRowOkButtonOptions.text="Ok"),y.oAddNewRowOkButtonOptions.click=a,y.oAddNewRowOkButtonOptions.id=y.sAddNewRowOkButtonId,i.push(y.oAddNewRowOkButtonOptions)):D.click(a),0==(N=e("#"+y.sAddNewRowCancelButtonId)).length?(null!=y.oAddNewRowCancelButtonOptions.text&&""!=y.oAddNewRowCancelButtonOptions.text||(y.oAddNewRowCancelButtonOptions.text="Cancel"),y.oAddNewRowCancelButtonOptions.click=l,y.oAddNewRowCancelButtonOptions.id=y.sAddNewRowCancelButtonId,i.push(y.oAddNewRowCancelButtonOptions)):N.click(l),i.length>0&&S.dialog("option","buttons",i),D=e("#"+y.sAddNewRowOkButtonId),N=e("#"+y.sAddNewRowCancelButtonId),null!=y.oAddNewRowFormValidation&&S.validate(y.oAddNewRowFormValidation)}else S=null;if(0!=(v=e("#"+y.sDeleteRowButtonId)).length?"true"!=v.data("delete-event-attached")&&(v.click(c),v.data("delete-event-attached","true")):v=null,oAddDeleteToolbar=e(y.sAddDeleteToolbarSelector),0!=oAddDeleteToolbar.length&&(null==O&&""!=y.sAddNewRowButtonId&&null!=S&&(oAddDeleteToolbar.append("<button id='"+y.sAddNewRowButtonId+"' class='add_row'>Add</button>"),(O=e("#"+y.sAddNewRowButtonId)).click(function(){S.dialog("open")})),null==v&&""!=y.sDeleteRowButtonId&&(oAddDeleteToolbar.append("<button id='"+y.sDeleteRowButtonId+"' class='delete_row'>Delete</button>"),(v=e("#"+y.sDeleteRowButtonId)).click(c))),null!=v&&(null!=y.oDeleteRowButtonOptions&&v.button(y.oDeleteRowButtonOptions),d()),null!=O&&null!=y.oAddNewRowButtonOptions&&O.button(y.oAddNewRowButtonOptions),null!=D&&null!=y.oAddNewRowOkButtonOptions&&D.button(y.oAddNewRowOkButtonOptions),null!=N&&null!=y.oAddNewRowCancelButtonOptions&&N.button(y.oAddNewRowCancelButtonOptions),e(".table-action-deletelink",g).live("click",u),y.bUseKeyTable?g.keys.event.focus(null,null,function(e,t,n){}):e("tbody",g).click(function(t){e(t.target.parentNode).hasClass(y.sSelectedRowClass)?(e(t.target.parentNode).removeClass(y.sSelectedRowClass),null!=v&&d()):(e(g.fnSettings().aoData).each(function(){e(this.nTr).removeClass(y.sSelectedRowClass)}),e(t.target.parentNode).addClass(y.sSelectedRowClass),null!=v&&r())}),null!=y.aoTableActions)for(var f=0;f<y.aoTableActions.length;f++){var p=e.extend({sType:"edit"},y.aoTableActions[f]),w=p.sAction,h=(p.sActionFormId,e("#form"+w));if(0!=h.length){var m={autoOpen:!1,modal:!0};m=e.extend({},p.oFormOptions,m),h.dialog(m),h.data("action-options",p);var C=e(".table-action-"+w);0!=C.length&&C.live("click",function(){var t=this.className.split(/\s+/),n="",o="";for(f=0;f<t.length;f++)t[f].indexOf("table-action-")>-1&&(n="#form"+(o=t[f].replace("table-action-","")));if(""==n&&y.fnShowError("Cannot find a form with an id "+n+" that should be associated to the action - "+o,o),"edit"==e(n).data("action-options").sType){var a=e(this).parents("tr")[0];b(h,a)}e(h).dialog("open")}),h.submit(function(e){return R(this),!1});var A=new Array,T=e("#form"+w+"Cancel",h);0!=T.length&&(A.push(T),T.click(function(){var t=e(this).parents("form")[0];e(t).validate().resetForm(),e(t)[0].reset(),e(".error",e(t)).html(""),e(".error",e(t)).hide(),e(t).dialog("close")})),e("button",h).button()}}})}}(jQuery);
